#!/bin/bash
# Pre-push hook for cambium-nms-templates
# Runs all test suites before allowing push

set -e

echo "üß™ Running pre-push tests..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the root of the git repository
REPO_ROOT=$(git rev-parse --show-toplevel)

# Check if Docker is running (required for integration tests)
if ! docker info > /dev/null 2>&1; then
    echo -e "${RED}‚úó Docker is not running${NC}"
    echo -e "${YELLOW}Start Docker and try again, or use 'git push --no-verify' to skip tests${NC}"
    exit 1
fi

echo ""
echo -e "${BLUE}Running all test suites...${NC}"
echo -e "${YELLOW}This may take several minutes (Docker containers will be started)${NC}"
echo ""

# Run the master test script
if "$REPO_ROOT/tests/run_all.sh"; then
    echo ""
    echo -e "${GREEN}‚úÖ All tests passed! Proceeding with push...${NC}"
    exit 0
else
    echo ""
    echo -e "${RED}‚ùå Tests failed! Push blocked.${NC}"
    echo -e "${YELLOW}Fix the failing tests and try again, or use 'git push --no-verify' to bypass (not recommended)${NC}"
    exit 1
fi
