#!/bin/bash
# Pre-commit hook for cambium-nms-templates
# Runs linting checks on staged files

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
CHECKS_FAILED=0

# Get the root of the git repository
REPO_ROOT=$(git rev-parse --show-toplevel)

# Python files that changed
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    echo "üìù Checking Python files..."

    # Run ruff on changed files
    if command -v ruff &> /dev/null; then
        echo "  ‚Üí Running ruff linter..."
        if ! ruff check $PYTHON_FILES; then
            echo -e "${RED}‚úó Ruff linting failed${NC}"
            echo -e "${YELLOW}  Fix with: ruff check --fix $PYTHON_FILES${NC}"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}‚úì Ruff linting passed${NC}"
        fi

        echo "  ‚Üí Running ruff formatter check..."
        if ! ruff format --check $PYTHON_FILES; then
            echo -e "${RED}‚úó Ruff formatting check failed${NC}"
            echo -e "${YELLOW}  Fix with: ruff format $PYTHON_FILES${NC}"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}‚úì Ruff formatting passed${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö† ruff not found - install with: pip install ruff${NC}"
        CHECKS_FAILED=1
    fi

    # Run mypy on changed files (optional - lenient for now)
    if command -v mypy &> /dev/null; then
        echo "  ‚Üí Running mypy type checker..."
        if ! mypy --ignore-missing-imports $PYTHON_FILES 2>/dev/null; then
            echo -e "${YELLOW}‚ö† Type checking found issues (not blocking)${NC}"
        else
            echo -e "${GREEN}‚úì Type checking passed${NC}"
        fi
    fi
fi

# YAML files that changed
YAML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(yaml|yml)$' || true)

if [ -n "$YAML_FILES" ]; then
    echo "üìÑ Checking YAML files..."

    if [ -f "$REPO_ROOT/.yamllint" ] && command -v yamllint &> /dev/null; then
        if ! yamllint -c "$REPO_ROOT/.yamllint" $YAML_FILES; then
            echo -e "${RED}‚úó YAML linting failed${NC}"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}‚úì YAML linting passed${NC}"
        fi
    else
        # Fallback: basic Python YAML syntax check
        echo "  ‚Üí Running basic YAML syntax check..."
        for file in $YAML_FILES; do
            if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo -e "${RED}‚úó YAML syntax error in $file${NC}"
                CHECKS_FAILED=1
            fi
        done
        if [ $CHECKS_FAILED -eq 0 ]; then
            echo -e "${GREEN}‚úì YAML syntax check passed${NC}"
        fi
    fi
fi

# Shell scripts that changed
SHELL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|bash)$' || true)

if [ -n "$SHELL_FILES" ]; then
    echo "üêö Checking shell scripts..."

    if command -v shellcheck &> /dev/null; then
        if ! shellcheck $SHELL_FILES; then
            echo -e "${RED}‚úó ShellCheck failed${NC}"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}‚úì ShellCheck passed${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö† shellcheck not found - install with: apt-get install shellcheck or brew install shellcheck${NC}"
    fi
fi

# Exit with failure if any checks failed
if [ $CHECKS_FAILED -eq 1 ]; then
    echo ""
    echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
    echo -e "${YELLOW}Fix the issues above or use 'git commit --no-verify' to bypass (not recommended)${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
