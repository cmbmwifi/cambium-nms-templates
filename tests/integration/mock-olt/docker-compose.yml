version: '3.8'

# Test infrastructure: Mock OLT devices
# Shared across all NMS integration tests (Zabbix, LibreNMS, etc.)

networks:
  test-network:
    name: zabbix-shared-network
    external: true

services:
  # Mock OLT devices (shared by all tests)
  olt1:
    container_name: mock-olt-1
    build:
      context: .
      dockerfile: Dockerfile
    hostname: olt-building-a
    networks:
      test-network:
        ipv4_address: 172.20.0.10
    ports:
      - "2222:22"
    volumes:
      - ./olt-sample-output.json:/app/fixtures/olt-sample-output.json:ro
    tmpfs:
      # Python and temp files in RAM
      - /tmp:rw,size=64M
      - /root/.cache:rw,size=32M
    environment:
      - OLT_NAME=OLT-Building-A
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 22))"]
      interval: 1s
      timeout: 2s
      retries: 30

  olt2:
    container_name: mock-olt-2
    build:
      context: .
      dockerfile: Dockerfile
    hostname: olt-building-b
    networks:
      test-network:
        ipv4_address: 172.20.0.11
    ports:
      - "2223:22"
    volumes:
      - ./olt-sample-output.json:/app/fixtures/olt-sample-output.json:ro
    tmpfs:
      # Python and temp files in RAM
      - /tmp:rw,size=64M
      - /root/.cache:rw,size=32M
    environment:
      - OLT_NAME=OLT-Building-B
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 22))"]
      interval: 3s
      timeout: 2s
      retries: 10
